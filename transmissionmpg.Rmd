---
title: "Impact of Transmission on Fuel Efficiency"
author: "Eduardo Bortoluzzi Junior"
date: "November 15, 2015"
output: pdf_document
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, 
                      results='hide', fig.show='hide')
```

<!--
You work for Motor Trend, a magazine about the automobile industry. Looking at a 
data set of a collection of cars, they are interested in exploring the 
relationship between a set of variables and miles per gallon (MPG) (outcome). 
They are particularly interested in the following two questions:

* "Is an automatic or manual transmission better for MPG"
* "Quantify the MPG difference between automatic and manual transmissions"

Take the mtcars data set and write up an analysis to answer their question using 
regression models and exploratory data analyses.

* Did the student interpret the coefficients correctly?
* Did the student do some exploratory data analyses?
* Did the student fit multiple models and detail their strategy for model 
  selection?
* Did the student answer the questions of interest or detail why the question(s) 
  is (are) not answerable?
* Did the student do a residual plot and some diagnostics?
* Did the student quantify the uncertainty in their conclusions and/or perform 
  an inference correctly?
* Was the report brief (about 2 pages long) for the main body of the report and 
  no longer than 5 with supporting appendix of figures?
* Did the report include an executive summary?
* Was the report done in Rmd (knitr)?

-->


```{r}
require(ggplot2)
```

```{r}
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```


```{r}
str(mtcars)
```

The data set *mtcars* has information on fuel consumption and 10 aspects of
automobile design and performance for 32 automobiles models of 1973 and 1974.

From physics, force (F) is defined as $F = m * a$, where *m* is mass and *a* is
acceleration; work (W) as $W = F * s$, where *s* is the displacement of the
object and energy (E) is needed to produce the work
($\partial W = \partial Q - dE$). Some heat (Q) is also produced in this
process.

For the internal combustion engine, the mechanical energy is produced by the
combustion of the fuel. So, the amount of combustion needed to make a automobile
displacement is highly dependent on the automobile mass. In this analysis, the
automobile weight `wt` will be used as the basis, and some other engine
variables will be selected for this model.

The starting model is below:

```{r echo=TRUE}
fit <- lm(mpg ~ wt, mtcars)
```

Using nested likelihood ratio tests, the adition of the variables about the 
engine construction will be tested on the hypothesis that the adition is not
significant to the anterior model.

```{r results='hold'}
fit1 <- update(fit, mpg ~ ( wt + hp) )
fit2 <- update(fit, mpg ~ ( wt + hp + disp) )
fit3 <- update(fit, mpg ~ ( wt + hp + disp + cyl) )

anova(fit, fit1, fit2, fit3)
```

Only the adition of gross horsepower (`hp`) is significant for the analysis, so
the model `lm(mpg ~ wt + hp, mtcars)` is used in this analysis. The plot1
shows the residuals of this model, and there are some outliers that is
influencing the model.

```{r}
PRESS <- data.frame(press=resid(fit1) / (1 - hatvalues(fit1)))
rownames(PRESS) <- rownames(mtcars)

PRESS.mean <- mean(PRESS$press)
PRESS.sd <- sd(PRESS$press)

boundaries <- qnorm(c(0.025, 0.975), mean=PRESS.mean, sd=PRESS.sd)

sub <- subset(PRESS, PRESS$press < boundaries[1] | PRESS$press > boundaries[2])

mtcars.n <- mtcars[!(rownames(mtcars) %in% rownames(sub)),]

fit1.n <- lm(mpg ~ wt + hp, mtcars.n)
```

Removing the observations which PRESS residuals is out of the 95% of the normal
density, which are `r rownames(sub)`, the new residuals will be those in plot2.

With this final fitted model, the regression lines for the cars with automatic
transmission and for the cars with manual transmission are extracted.

```{r}
fit.am <- lm(mpg ~ factor(am) * (wt + hp), mtcars.n)
coef.fit.am <- summary(fit.am)$coef

```

```{r}
fit.a <- lm(mpg ~ wt + hp, mtcars.n[mtcars.n$am==0,])
fit.m <- lm(mpg ~ wt + hp, mtcars.n[mtcars.n$am==1,])
```

```{r}
fit.a <- lm(mpg ~ I(wt - mean(wt)) + I(hp - mean(hp)), mtcars.n[mtcars.n$am==0,])
fit.m <- lm(mpg ~ I(wt - mean(wt)) + I(hp - mean(hp)), mtcars.n[mtcars.n$am==1,])
```

# Appendix

## plot1
```{r plot1, fig.show='asis'}
plot(fit1, which=1)
```

## plot2
```{r plot2, fig.show='asis'}
plot(fit1.n, which=1)
```
